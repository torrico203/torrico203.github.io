<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>간단한 게시판</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        min-height: 100vh;
        padding: 0;
        box-sizing: border-box;
        overflow-x: hidden;
      }
      .main-layout {
        display: flex;
        width: 100%;
        overflow: hidden;
      }
      .sidebar {
        width: 280px;
        background-color: #f9fafb;
        padding: 2rem;
        border-right: 1px solid #e5e7eb;
        flex-shrink: 0;
        overflow-y: auto;
        position: fixed;
        height: 100vh;
        top: 0;
        left: 0;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-radius: 0 1rem 1rem 0;
        padding-top: 2rem;
      }
      .content-wrapper {
        flex-grow: 1;
        margin-left: 280px;
        padding: 2rem;
        overflow-y: auto;
        width: calc(100% - 280px);
        box-sizing: border-box;
      }
      .content-area {
        max-width: 920px;
        margin: 0 auto;
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 2rem;
      }
      .post-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        padding: 1.25rem;
        background-color: #f9fafb;
        transition: all 0.3s ease-in-out;
        overflow: hidden;
      }
      .post-card.expanded {
        background-color: #ffffff;
        border-color: #6366f1;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .post-subtitle-summary {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
      }
      .toggle-button {
        width: 32px;
        height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1;
      }
      .sidebar-item {
        padding: 0.75rem 0.5rem;
        cursor: pointer;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s ease-in-out;
      }
      .sidebar-item:hover {
        background-color: #eef2ff;
        color: #4f46e5;
      }
      .sidebar-item.active {
        background-color: #e0e7ff;
        color: #4338ca;
        font-weight: 600;
      }

      .action-buttons-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-left: 1rem;
        flex-shrink: 0;
        min-width: 130px;
        justify-content: flex-end;
      }
      .title-subtitle-container {
        flex: 1;
        min-width: 0;
        padding-right: 1rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .sidebar {
          position: static;
          width: 100%;
          height: auto;
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
          max-height: 200px;
          border-radius: 1rem 1rem 0 0;
        }
        .content-wrapper {
          margin-left: 0;
          width: 100%;
          padding-top: 1rem;
        }
        .content-area {
          padding: 1rem;
        }
      }
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Custom Modal Styles */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      .modal-buttons {
        margin-top: 1.5rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
      }
      .modal-buttons button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
      }
      .modal-buttons .confirm-button {
        background-color: #6366f1;
        color: white;
      }
      .modal-buttons .confirm-button:hover {
        background-color: #4f46e5;
      }
      .modal-buttons .cancel-button {
        background-color: #e5e7eb;
        color: #4b5563;
      }
      .modal-buttons .cancel-button:hover {
        background-color: #d1d5db;
      }
      /* Video iframe responsive container */
      .video-responsive-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        margin-top: 1rem;
        border-radius: 0.5rem;
      }
      .video-responsive-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="main-layout">
      <!-- 사이드바 -->
      <div class="sidebar">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">재그(JaeG)</h2>
        <div id="sidebar-posts-list">
          <!-- Sidebar titles will be rendered here -->
        </div>
      </div>

      <!-- 메인 콘텐츠를 감싸는 새로운 래퍼 -->
      <div class="content-wrapper">
        <div class="content-area">
          <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            게임 아이디어 정리
          </h1>

          <!-- Admin Mode Controls -->
          <div
            id="admin-mode-controls"
            class="mb-8 p-6 bg-yellow-50 rounded-lg shadow-md"
          >
            <h2 class="text-2xl font-semibold text-yellow-700 mb-4">
              관리자 모드
            </h2>
            <div class="space-y-4">
              <div>
                <label
                  for="admin-password"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >비밀번호 입력</label
                >
                <input
                  type="password"
                  id="admin-password"
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm"
                />
              </div>
              <button
                id="toggle-admin-mode-button"
                class="w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition duration-150 ease-in-out"
              >
                관리자 모드 활성화/비활성화
              </button>
              <p
                id="admin-status"
                class="text-center text-sm font-medium text-yellow-800 mt-2"
              >
                관리자 모드: 비활성화됨
              </p>
            </div>
          </div>

          <!-- New Post Form (Conditionally visible) -->
          <div
            id="add-post-form-container"
            class="mb-8 p-6 bg-indigo-50 rounded-lg shadow-md"
            style="display: none"
          >
            <h2 class="text-2xl font-semibold text-indigo-700 mb-4">
              새 글 추가
            </h2>
            <form id="add-post-form" class="space-y-4">
              <div>
                <label
                  for="post-title"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >제목</label
                >
                <input
                  type="text"
                  id="post-title"
                  name="title"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label
                  for="post-subtitle"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >부제목</label
                >
                <input
                  type="text"
                  id="post-subtitle"
                  name="subtitle"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label
                  for="post-content"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >내용</label
                >
                <textarea
                  id="post-content"
                  name="content"
                  rows="5"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                ></textarea>
              </div>
              <div>
                <label
                  for="post-video-url"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >영상 URL (선택 사항)</label
                >
                <input
                  type="url"
                  id="post-video-url"
                  name="video_url"
                  placeholder="예: https://www.youtube.com/embed/VIDEO_ID 또는 Google Drive 임베드 링크 (https://drive.google.com/embed?id=FILE_ID)"
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <button
                type="submit"
                class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out"
              >
                게시물 추가
              </button>
            </form>
          </div>

          <!-- 게시물 목록 -->
          <div id="posts-list">
            <div id="loading-spinner" class="loading-spinner"></div>
            <!-- Posts will be rendered here by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="modal-backdrop hidden">
      <div class="modal-content">
        <p id="alert-message" class="text-lg font-semibold text-gray-800"></p>
        <div class="modal-buttons">
          <button class="confirm-button" onclick="hideCustomAlert()">
            확인
          </button>
        </div>
      </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="modal-backdrop hidden">
      <div class="modal-content">
        <p id="confirm-message" class="text-lg font-semibold text-gray-800"></p>
        <div class="modal-buttons">
          <button class="confirm-button" id="confirm-ok-button">확인</button>
          <button class="cancel-button" id="confirm-cancel-button">취소</button>
        </div>
      </div>
    </div>

    <script>
      // Supabase 클라이언트 초기화
      const SUPABASE_URL = "https://zjayzfjifsmajisfsgpn.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqYXl6ZmppZnNtYWppc2ZzZ3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MzkxNjgsImV4cCI6MjA3MDAxNTE2OH0.T7_4I6qvaPOAbJ5KFRhiEAokVSbmosPC1dUyHLVeLNI";
      let supabase;

      try {
        console.log("Supabase 클라이언트 초기화 시도...");
        supabase = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY
        );
        console.log("Supabase 클라이언트 초기화 성공:", supabase);
      } catch (e) {
        console.error("Supabase 클라이언트 초기화 오류:", e.message);
        showCustomAlert(
          "Supabase 클라이언트 초기화 중 오류가 발생했습니다. 콘솔을 확인해주세요."
        );
      }

      let posts = [];
      const MAX_SUBTITLE_LENGTH = 70;
      const ADMIN_PASSWORD = "snowLYNbellGUN";
      let isAdminMode = false;

      const postsList = document.getElementById("posts-list");
      const sidebarPostsList = document.getElementById("sidebar-posts-list");
      const addPostFormContainer = document.getElementById(
        "add-post-form-container"
      );
      const addPostForm = document.getElementById("add-post-form");
      const loadingSpinner = document.getElementById("loading-spinner");
      const adminPasswordInput = document.getElementById("admin-password");
      const toggleAdminModeButton = document.getElementById(
        "toggle-admin-mode-button"
      );
      const adminStatusText = document.getElementById("admin-status");
      const adminModeControls = document.getElementById("admin-mode-controls");

      const customAlertDialog = document.getElementById("custom-alert-modal");
      const customAlertMessage = document.getElementById("alert-message");
      const customConfirmDialog = document.getElementById(
        "custom-confirm-modal"
      );
      const customConfirmMessage = document.getElementById("confirm-message");
      const customConfirmOkButton =
        document.getElementById("confirm-ok-button");
      const customConfirmCancelButton = document.getElementById(
        "confirm-cancel-button"
      );

      function showCustomAlert(message) {
        customAlertMessage.textContent = message;
        customAlertDialog.classList.remove("hidden");
      }

      function hideCustomAlert() {
        customAlertDialog.classList.add("hidden");
      }

      function showCustomConfirm(message, onConfirm, onCancel) {
        customConfirmMessage.textContent = message;
        customConfirmDialog.classList.remove("hidden");

        const handleOk = () => {
          onConfirm();
          hideCustomConfirm();
        };
        const handleCancel = () => {
          onCancel();
          hideCustomConfirm();
        };

        customConfirmOkButton.removeEventListener("click", handleOk);
        customConfirmCancelButton.removeEventListener("click", handleCancel);

        customConfirmOkButton.addEventListener("click", handleOk);
        customConfirmCancelButton.addEventListener("click", handleCancel);
      }

      function hideCustomConfirm() {
        customConfirmDialog.classList.add("hidden");
      }

      function getTruncatedSubtitle(text, maxLength) {
        if (text.length > maxLength) {
          return text.substring(0, maxLength - 3) + "...";
        }
        return text;
      }

      function createPostElement(post) {
        const postCard = document.createElement("div");
        postCard.id = `post-${post.id}`;
        postCard.classList.add("post-card", "relative", "overflow-hidden");

        if (post.expanded) {
          postCard.classList.add("expanded");
        }

        const header = document.createElement("div");
        header.classList.add("flex", "justify-between", "items-start", "mb-2");

        const titleAndSubtitleContainer = document.createElement("div");
        titleAndSubtitleContainer.classList.add("title-subtitle-container");

        if (post.isEditing) {
          const titleInput = document.createElement("input");
          titleInput.type = "text";
          titleInput.id = `edit-title-${post.id}`;
          titleInput.value = post.title;
          titleInput.classList.add(
            "w-full",
            "bg-gray-50",
            "border",
            "border-gray-300",
            "rounded-md",
            "p-1",
            "text-xl",
            "font-semibold",
            "text-gray-900",
            "mb-1"
          );
          titleAndSubtitleContainer.appendChild(titleInput);

          const subtitleInput = document.createElement("input");
          subtitleInput.type = "text";
          subtitleInput.id = `edit-subtitle-${post.id}`;
          subtitleInput.value = post.subtitle;
          subtitleInput.classList.add(
            "w-full",
            "bg-gray-50",
            "border",
            "border-gray-300",
            "rounded-md",
            "p-1",
            "text-gray-600",
            "text-sm"
          );
          titleAndSubtitleContainer.appendChild(subtitleInput);
        } else {
          const title = document.createElement("h2");
          title.classList.add(
            "text-xl",
            "font-semibold",
            "text-gray-900",
            "mb-1"
          );
          title.textContent = post.title;
          titleAndSubtitleContainer.appendChild(title);

          const subtitle = document.createElement("p");
          subtitle.classList.add("text-gray-600", "text-sm");

          if (!post.expanded) {
            subtitle.classList.add("post-subtitle-summary");
            subtitle.textContent = getTruncatedSubtitle(
              post.subtitle,
              MAX_SUBTITLE_LENGTH
            );
          } else {
            subtitle.textContent = post.subtitle;
          }
          titleAndSubtitleContainer.appendChild(subtitle);
        }
        header.appendChild(titleAndSubtitleContainer);

        const actionButtonsContainer = document.createElement("div");
        actionButtonsContainer.classList.add("action-buttons-wrapper");

        if (isAdminMode) {
          if (post.isEditing) {
            const saveButton = document.createElement("button");
            saveButton.classList.add(
              "bg-green-600",
              "text-white",
              "py-1",
              "px-3",
              "rounded-md",
              "hover:bg-green-700",
              "focus:outline-none",
              "focus:ring-2",
              "focus:ring-offset-2",
              "focus:ring-green-500",
              "transition"
            );
            saveButton.textContent = "저장";
            saveButton.addEventListener("click", () => savePost(post.id));
            actionButtonsContainer.appendChild(saveButton);

            const cancelButton = document.createElement("button");
            cancelButton.classList.add(
              "bg-red-600",
              "text-white",
              "py-1",
              "px-3",
              "rounded-md",
              "hover:bg-red-700",
              "focus:outline-none",
              "focus:ring-2",
              "focus:ring-offset-2",
              "focus:ring-red-500",
              "transition"
            );
            cancelButton.textContent = "취소";
            cancelButton.addEventListener("click", () => cancelEdit(post.id));
            actionButtonsContainer.appendChild(cancelButton);
          } else {
            const editButton = document.createElement("button");
            editButton.classList.add(
              "bg-blue-100",
              "text-blue-600",
              "py-1",
              "px-3",
              "rounded-md",
              "hover:bg-blue-200",
              "focus:outline-none",
              "focus:ring-2",
              "focus:ring-offset-2",
              "focus:ring-blue-500",
              "transition"
            );
            editButton.textContent = "수정";
            editButton.addEventListener("click", () => toggleEdit(post.id));
            actionButtonsContainer.appendChild(editButton);

            const deleteButton = document.createElement("button");
            deleteButton.classList.add(
              "bg-gray-100",
              "text-gray-600",
              "py-1",
              "px-3",
              "rounded-md",
              "hover:bg-gray-200",
              "focus:outline-none",
              "focus:ring-2",
              "focus:ring-offset-2",
              "focus:ring-gray-500",
              "transition"
            );
            deleteButton.textContent = "삭제";
            deleteButton.addEventListener("click", () => deletePost(post.id));
            actionButtonsContainer.appendChild(deleteButton);
          }
        }

        const toggleButton = document.createElement("button");
        toggleButton.classList.add(
          "toggle-button",
          "bg-indigo-100",
          "text-indigo-600",
          "rounded-full",
          "hover:bg-indigo-200",
          "focus:outline-none",
          "focus:ring-2",
          "focus:ring-indigo-500",
          "focus:ring-offset-2",
          "transition",
          "duration-150",
          "ease-in-out"
        );
        toggleButton.textContent = post.expanded ? "-" : "+";
        toggleButton.addEventListener("click", () => togglePost(post.id));
        actionButtonsContainer.appendChild(toggleButton);

        header.appendChild(actionButtonsContainer);
        postCard.appendChild(header);

        const contentContainer = document.createElement("div");
        contentContainer.classList.add(
          "text-gray-700",
          "text-base",
          "mt-4",
          "leading-relaxed"
        );
        if (!post.expanded && !post.isEditing) {
          contentContainer.classList.add("hidden");
        }

        if (post.isEditing) {
          const contentTextarea = document.createElement("textarea");
          contentTextarea.id = `edit-content-${post.id}`;
          contentTextarea.rows = 5;
          contentTextarea.value = post.content;
          contentTextarea.classList.add(
            "w-full",
            "bg-gray-50",
            "border",
            "border-gray-300",
            "rounded-md",
            "p-2",
            "text-base",
            "mb-2"
          );
          contentContainer.appendChild(contentTextarea);

          const videoUrlInput = document.createElement("input");
          videoUrlInput.type = "url";
          videoUrlInput.id = `edit-video-url-${post.id}`;
          videoUrlInput.value = post.video_url || "";
          videoUrlInput.placeholder =
            "예: https://www.youtube.com/embed/VIDEO_ID 또는 Google Drive 임베드 링크 (https://drive.google.com/embed?id=FILE_ID)";
          videoUrlInput.classList.add(
            "w-full",
            "bg-gray-50",
            "border",
            "border-gray-300",
            "rounded-md",
            "p-2",
            "text-base"
          );
          contentContainer.appendChild(videoUrlInput);
        } else {
          contentContainer.innerHTML = post.content.replace(/\n/g, "<br>");

          if (post.video_url) {
            const videoWrapper = document.createElement("div");
            videoWrapper.classList.add("video-responsive-container");
            const iframe = document.createElement("iframe");
            iframe.src = post.video_url;
            iframe.setAttribute("allowfullscreen", "");
            iframe.setAttribute("frameborder", "0");
            iframe.setAttribute(
              "allow",
              "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            );
            videoWrapper.appendChild(iframe);
            contentContainer.appendChild(videoWrapper);
          }
        }
        postCard.appendChild(contentContainer);

        return postCard;
      }

      function renderPosts() {
        postsList.innerHTML = "";
        if (posts.length === 0) {
          postsList.innerHTML =
            '<p class="text-center text-gray-500 mt-8">게시물이 없습니다. 새 글을 추가해 보세요!</p>';
        } else {
          const sortedPosts = [...posts].sort(
            (a, b) => new Date(b.created_at) - new Date(a.created_at)
          );
          sortedPosts.forEach((post) => {
            postsList.appendChild(createPostElement(post));
          });
        }
        renderSidebar();
        updateAdminModeUI();
      }

      function renderSidebar() {
        sidebarPostsList.innerHTML = "";

        const sortedPosts = [...posts].sort(
          (a, b) => new Date(b.created_at) - new Date(a.created_at)
        );
        sortedPosts.forEach((post) => {
          const sidebarItem = document.createElement("div");
          sidebarItem.classList.add(
            "sidebar-item",
            "text-gray-700",
            "font-medium"
          );
          sidebarItem.textContent = post.title;
          sidebarItem.dataset.postId = post.id;

          sidebarItem.addEventListener("click", () => {
            document.querySelectorAll(".sidebar-item").forEach((item) => {
              item.classList.remove("active");
            });
            sidebarItem.classList.add("active");

            const targetPost = document.getElementById(`post-${post.id}`);
            if (targetPost) {
              targetPost.scrollIntoView({ behavior: "smooth", block: "start" });
              const postIndex = posts.findIndex((p) => p.id === post.id);
              if (postIndex > -1) {
                posts.forEach((p, i) => {
                  if (i === postIndex) {
                    p.expanded = true;
                  } else {
                    p.expanded = false;
                  }
                  p.isEditing = false;
                });
                renderPosts();
              }
            }
          });
          sidebarPostsList.appendChild(sidebarItem);
        });
      }

      function togglePost(id) {
        const postIndex = posts.findIndex((p) => p.id === id);
        if (postIndex > -1) {
          if (posts[postIndex].isEditing) {
            return;
          }
          posts[postIndex].expanded = !posts[postIndex].expanded;
          renderPosts();
        }
      }

      function toggleEdit(id) {
        if (!isAdminMode) {
          showCustomAlert(
            "관리자 모드를 활성화해야 게시물을 수정할 수 있습니다."
          );
          return;
        }
        const currentlyEditingPost = posts.find((p) => p.isEditing);
        if (currentlyEditingPost && currentlyEditingPost.id !== id) {
          currentlyEditingPost.isEditing = false;
        }

        const postIndex = posts.findIndex((p) => p.id === id);
        if (postIndex > -1) {
          posts[postIndex].isEditing = !posts[postIndex].isEditing;
          if (posts[postIndex].isEditing && !posts[postIndex].expanded) {
            posts[postIndex].expanded = true;
          }
          renderPosts();
        }
      }

      async function savePost(id) {
        if (!isAdminMode) {
          showCustomAlert(
            "관리자 모드를 활성화해야 게시물을 저장할 수 있습니다."
          );
          return;
        }
        const postIndex = posts.findIndex((p) => p.id === id);
        if (postIndex > -1) {
          const titleInput = document.getElementById(`edit-title-${id}`);
          const subtitleInput = document.getElementById(`edit-subtitle-${id}`);
          const contentInput = document.getElementById(`edit-content-${id}`);
          const videoUrlInput = document.getElementById(`edit-video-url-${id}`);

          if (titleInput && subtitleInput && contentInput && videoUrlInput) {
            const { data, error } = await supabase
              .from("posts")
              .update({
                title: titleInput.value,
                subtitle: subtitleInput.value,
                content: contentInput.value,
                video_url: videoUrlInput.value || null,
              })
              .eq("id", id);

            if (error) {
              console.error("Error updating post:", error.message);
              showCustomAlert(
                "게시물 업데이트 중 오류가 발생했습니다: " + error.message
              );
            } else {
              console.log("Post updated successfully:", data);
              posts[postIndex].title = titleInput.value;
              posts[postIndex].subtitle = subtitleInput.value;
              posts[postIndex].content = contentInput.value;
              posts[postIndex].video_url = videoUrlInput.value || null;
              posts[postIndex].isEditing = false;
              renderPosts();
              showCustomAlert("게시물이 성공적으로 업데이트되었습니다!");
            }
          }
        }
      }

      function cancelEdit(id) {
        const postIndex = posts.findIndex((p) => p.id === id);
        if (postIndex > -1) {
          posts[postIndex].isEditing = false;
          renderPosts();
        }
      }

      addPostForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        if (!isAdminMode) {
          showCustomAlert(
            "관리자 모드를 활성화해야 새 게시물을 추가할 수 있습니다."
          );
          return;
        }

        const titleInput = document.getElementById("post-title");
        const subtitleInput = document.getElementById("post-subtitle");
        const contentInput = document.getElementById("post-content");
        const videoUrlInput = document.getElementById("post-video-url");

        const newPostData = {
          title: titleInput.value,
          subtitle: subtitleInput.value,
          content: contentInput.value,
          video_url: videoUrlInput.value || null,
        };

        const { data, error } = await supabase
          .from("posts")
          .insert([newPostData]);

        if (error) {
          console.error("Error adding new post:", error.message);
          showCustomAlert(
            "새 게시물 추가 중 오류가 발생했습니다: " + error.message
          );
        } else {
          console.log("New post added successfully:", data);
          showCustomAlert("새 게시물이 성공적으로 추가되었습니다!");
          titleInput.value = "";
          subtitleInput.value = "";
          contentInput.value = "";
          videoUrlInput.value = "";
        }
      });

      async function deletePost(id) {
        if (!isAdminMode) {
          showCustomAlert(
            "관리자 모드를 활성화해야 게시물을 삭제할 수 있습니다."
          );
          return;
        }

        showCustomConfirm(
          "이 게시물을 정말 삭제하시겠습니까?",
          async () => {
            const { error } = await supabase
              .from("posts")
              .delete()
              .eq("id", id);

            if (error) {
              console.error("Error deleting post:", error.message);
              showCustomAlert(
                "게시물 삭제 중 오류가 발생했습니다: " + error.message
              );
            } else {
              console.log("Post deleted successfully.");
              showCustomAlert("게시물이 성공적으로 삭제되었습니다!");
            }
          },
          () => {
            console.log("게시물 삭제가 취소되었습니다.");
          }
        );
      }

      toggleAdminModeButton.addEventListener("click", () => {
        const enteredPassword = adminPasswordInput.value;
        if (enteredPassword === ADMIN_PASSWORD) {
          isAdminMode = !isAdminMode;
          adminPasswordInput.value = "";
          renderPosts();
          showCustomAlert(
            `관리자 모드가 ${isAdminMode ? "활성화" : "비활성화"}되었습니다.`
          );
        } else {
          showCustomAlert("비밀번호가 올바르지 않습니다.");
        }
      });

      function updateAdminModeUI() {
        if (isAdminMode) {
          adminModeControls.style.display = "none";
          addPostFormContainer.style.display = "block";
          adminStatusText.textContent = "관리자 모드: 활성화됨";
          adminStatusText.classList.remove("text-yellow-800");
          adminStatusText.classList.add("text-green-800");
        } else {
          adminModeControls.style.display = "block";
          addPostFormContainer.style.display = "none";
          adminStatusText.textContent = "관리자 모드: 비활성화됨";
          adminStatusText.classList.remove("text-green-800");
          adminStatusText.classList.add("text-yellow-800");
        }
      }

      // 현재 구독 중인 채널을 추적하기 위한 변수
      let currentSupabaseChannel = null;

      async function fetchAndSubscribePosts() {
        if (!supabase) {
          console.error(
            "Supabase 클라이언트가 초기화되지 않았습니다. 데이터를 불러올 수 없습니다."
          );
          postsList.innerHTML =
            '<p class="text-center text-red-500 mt-8">Supabase 연결 오류: 게시물을 불러올 수 없습니다. 콘솔을 확인해주세요.</p>';
          loadingSpinner.style.display = "none";
          return;
        }

        loadingSpinner.style.display = "block";
        console.log("게시물 초기 로드 및 구독 시도...");

        const { data, error } = await supabase
          .from("posts")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error("초기 게시물 불러오기 오류:", error.message);
          postsList.innerHTML =
            '<p class="text-center text-red-500 mt-8">게시물을 불러오는 중 오류가 발생했습니다: ' +
            error.message +
            "</p>";
        } else {
          console.log("초기 게시물 불러오기 성공:", data.length, "개");
          posts = data;
          renderPosts();
        }
        loadingSpinner.style.display = "none";

        // 기존 구독이 있다면 해제
        if (currentSupabaseChannel) {
          console.log("기존 Supabase Realtime 구독 해제 시도...");
          await supabase.removeChannel(currentSupabaseChannel);
          console.log("기존 Supabase Realtime 구독 해제 완료.");
        }

        try {
          console.log("Supabase Realtime 구독 시도...");
          currentSupabaseChannel = supabase
            .channel("public:posts")
            .on(
              "postgres_changes",
              { event: "*", schema: "public", table: "posts" },
              (payload) => {
                console.log("*** REALTIME EVENT RECEIVED ***", payload); // 새로운 로그 추가
                console.log("Change received from Supabase Realtime!", payload);
                // 변경된 데이터에 따라 posts 배열 업데이트
                if (payload.eventType === "INSERT") {
                  posts.unshift(payload.new); // 새 게시물은 맨 앞에 추가
                } else if (payload.eventType === "UPDATE") {
                  const index = posts.findIndex((p) => p.id === payload.new.id);
                  if (index !== -1) {
                    posts[index] = { ...posts[index], ...payload.new }; // 기존 객체에 새 데이터 병합
                  }
                } else if (payload.eventType === "DELETE") {
                  posts = posts.filter((p) => p.id !== payload.old.id); // 삭제된 게시물 제거
                }
                renderPosts(); // UI 다시 렌더링
              }
            )
            .subscribe((status, err) => {
              console.log(
                "Supabase Realtime Subscription Status (Callback):",
                status
              ); // subscribe 콜백 상태 로그
              if (status === "SUBSCRIBED") {
                console.log("Supabase Realtime 구독 상태: SUBSCRIBED");
              } else if (status === "CHANNEL_ERROR") {
                console.error("Supabase Realtime 구독 채널 오류:", err);
                showCustomAlert(
                  "Supabase 실시간 구독 채널 오류가 발생했습니다. 콘솔을 확인해주세요."
                );
              } else if (status === "TIMED_OUT") {
                console.warn("Supabase Realtime 구독 시간 초과.");
                showCustomAlert(
                  "Supabase 실시간 구독 시간 초과. 네트워크 연결을 확인해주세요."
                );
              } else if (status === "CLOSED") {
                console.log("Supabase Realtime 구독 상태: CLOSED");
              } else if (status === "ERRORED") {
                console.error("Supabase Realtime 구독 상태: ERRORED", err);
              } else {
                console.log("Supabase Realtime 구독 상태:", status);
              }
            });
          console.log("Supabase Realtime 구독 호출 완료.");
        } catch (e) {
          console.error("Supabase Realtime 구독 오류 (try-catch):", e.message);
          showCustomAlert(
            "Supabase 실시간 구독 중 오류가 발생했습니다. 콘솔을 확인해주세요."
          );
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log(
          "DOMContentLoaded 이벤트 발생. fetchAndSubscribePosts 호출."
        );
        fetchAndSubscribePosts();
      });
    </script>
  </body>
</html>
